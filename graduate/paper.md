## 论文题目：基于对象合并的小文件优化研究

硕士毕业论文提纲：

```
1 绪论
	1.1 课题背景
	1.2 国内外研究现状
	1.3 本文研究的主要内容
	1.4 论文结构安排
2 对象存储服务器的小文件问题
	2.1 分布式文件系统capfs的架构
	2.2 capfs的对象存储服务器的小文件问题
	2.3 常见的小文件优化方案
	2.4 本章小结
3 对象合并策略
	3.1 基于用户的合并策略
	3.2 索引的设计
	3.3 合并对象的元数据管理
	3.4 对象存储服务器的读写流程优化
	3.3 本章小结
4 对象合并策略的实现
	4.1 对象合并策略的基本架构
	4.2 索引的实现
	4.3 对象读写流程的优化实现
	4.4 本章小结
5 测试分析
	5.1 小文件读写测试
	5.2 大文件读写测试
	5.3 本章小结
6 全文总结
```

### 3 对象合并策略

#### 3.1 基于用户的合并策略

    采用合并策略，最重要的问题就是：(1) 将多大的对象进行合并，(2) 将哪些对象合并成一个对象。首先，将多大的对象进行合并，也就是说，多大的对象才被作为小对象。在Hadoop中，以64MB为块进行存储，因此，一些对Hadoop小文件的优化将小于64MB的文件定义为小文件，也就是说，将小于64MB的文件进行合并。在这里，为了使存储服务器能够获得较高的带宽，测试存储服务器在使用不同的对象大小时的读写带宽。

    从上图可以知道，当对象大小小于16MB时，带宽持续增加，当对象大小大于16MB时，带宽基本保持不变。因此，我们希望对象的大小至少应该大于16MB，才能使得存储服务器有较高的带宽。另一方面，如果对象设置得过大，合并对象中包含较多的小对象，就会增加合并对象中小对象的查找的开销。因此，在综合考虑存储服务器的带宽和小对象的查找的开销的情况下，将小于16MB的对象定义为小对象，即将小于16MB的对象合并为大于16MB的对象。

    另一个问题是，将哪些对象合并成一个对象。合并的策略应该考虑对象的访问局部性，也就是说，当用户访问某个合并对象的某个小对象时，希望用户接下来访问该合并对象中的另一个小对象。对象原始的组织方式是分散在多个目录下，按照通常的理解，可能的方案或许是将目录下的对象进行合并。但是，通过前面对capfs的介绍可以知道，对象ID相邻的对象分布在不同的目录下，因此，按照目录进行合并是不合适的。由于存储服务器可供多个客户端使用，因此，为了考虑。

#### 3.2 索引的设计

    对对象的操作无外乎增、删、改、查，其中，最常用的就是增和查，分别对应于对象的写和读。然而，将若干个小对象合并成一个大对象后，关键的问题是：如何读取某个特定的小对象。因此，为了查找某个特定的小对象，对每个合并对象建立一个索引文件，索引文件中的每个索引分别对应于合并对象中的每个对象。

    首先需要解决的问题是：索引文件的结构和索引的访问。

    最简单的索引文件的结构是，小对象和索引一一对应，如下图所示：

    这种方式实现比较简单，但是，当客户端写入一个对象时，存储服务器需要进行两次写入操作：一次是写合并对象，一次是写索引文件。开销较大。

    另一种方式是，对索引文件建立缓存，如下图所示，该方法将索引文件在内存中构成一个哈希表，当要写入索引时，将索引信息写入哈希表，然后在适当的时机将索引信息同步到持久存储。该方法的问题是，从索引文件构建内存哈希表有开销，而且，当存储服务器意外宕机时，内存中的索引信息有可能于持久存储的额索引信息不同步，从而导致索引信息的丢失。

    这里采用的方法既可以满足上面的提到的开销问题，又可以保证索引信息的同步。

    如下图所示，将索引文件构造成隐式哈希表的格式，对它的访问采用共享内存。

#### 3.3 合并对象的元数据管理

    确切地说，将小对象合并后，元数据的数量确实是增多了，因为合并对象本身也有元数据，问题在于，如何高效管理合并对象的元数据，减小管理元数据的开销。
