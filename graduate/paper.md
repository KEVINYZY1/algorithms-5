## 论文题目：基于对象合并的小文件优化研究

硕士毕业论文提纲：

```
1 绪论
	1.1 课题背景
	1.2 国内外研究现状
	1.3 本文研究的主要内容
	1.4 论文结构安排
2 对象存储服务器的小文件问题
	2.1 分布式文件系统capfs
	2.2 文件的读写流程分析
	2.3 capfs的小文件问题分析
	2.4 常见的小文件优化方案
	2.5 本章小结
3 对象合并策略
	3.1 基于用户的合并策略
	3.2 对象合并策略的系统架构
	3.3 索引的设计
	3.4 合并对象的元数据管理
	3.5 对象存储服务器的读写流程优化
	3.6 本章小结
4 对象合并策略的实现
	4.1 索引的实现及优化
	4.2 对象读写流程的优化实现
	4.3 本章小结
5 测试分析
	5.1 小文件读写测试
		iozone测试
		语料库测试
	5.2 大文件读写测试
	5.3 本章小结
6 全文总结
```

(1) 合并策略：基于对象
(2) 文件名：BlockID@Offset

### 2 对象存储服务器的小文件问题

#### 2.1 分布式文件系统capfs

以下所有的工作都是基于实验室自主研发的分布式文件系统capfs，因此，有必要简单介绍下分布式文件系统capfs。

分布式文件系统capfs由三个部分组成：元数据服务器(MetaData Server，简称MDS)、对象存储服务器(Object Storage Device，简称OSD)、客户端(Client)。其中，元数据服务器用于存储整个文件系统的元数据，主要是文件与对象的映射关系、对象的布局等。对象存储服务器以对象的形式保存数据，对客户端提供数据存储支持。客户端以虚拟文件系统的形式在系统中构建出一个文件系统，对用户展现统一的接口。

#### 2.2 文件的读写流程分析

文件系统的基本功能就是供用户进行数据的读写。在capfs中，当用户在读写文件时，客户端就会与元数据服务器和对象存储服务器进行多次通信。

写文件流程分析：

如下图所示，当用户写一个文件时，

### 3 对象合并策略

#### 3.1 基于用户的合并策略

采用合并策略，最重要的问题就是：(1) 将多大的对象进行合并，(2) 将哪些对象合并成一个对象。首先，将多大的对象进行合并，也就是说，多大的对象才被作为小对象。在Hadoop中，以64MB为块进行存储，因此，一些对Hadoop小文件的优化将小于64MB的文件定义为小文件，也就是说，将小于64MB的文件进行合并，但是，这样做只是从文件的大小考虑，没有综合权衡存储服务器的读写带宽和小对象的查找开销。在这里，通过测试存储服务器在使用不同的对象大小时的读写带宽来确定小文件的阈值。

从上图可以知道，当对象大小小于16MB时，存储服务器的读写带宽持续增加，当对象大小大于16MB时，带宽基本保持不变。因此，我们希望对象的大小至少应该大于16MB，才能使得存储服务器有较高的带宽。另一方面，如果阈值设置得过大，合并对象中包含较多的小对象，就会增加合并对象中小对象的查找的开销。因此，在综合考虑存储服务器的带宽和小对象的查找的开销的情况下，将小于16MB的对象定义为小对象，即将小于16MB的对象合并为大于16MB的对象。

其次，将哪些对象合并成一个对象。合并的策略应该考虑对象的访问局部性，也就是说，当客户端访问某个合并对象中的某个小对象时，希望客户端接下来访问该合并对象中的另一个小对象。对象原始的组织方式是分散在多个目录下，按照通常的理解，可能的方案是将目录下的对象进行合并。但是，通过前面对capfs的介绍可以知道，对象ID相邻的对象分布在不同的目录下，因此，按照目录进行合并是不合适的。由于存储服务器可供多个客户端使用，考虑到用户访问数据的局部性，某个用户读和写的数据应该是有所关联的，最好的方案应该是按照用户进行合并，也就是说，将某个用户写入的小对象进行合并。

#### 3.2 对象合并策略的系统架构

对象合并策略的设计主要包含：索引的设计、合并对象的设计、合并对象的元数据管理以及读写流程的优化。

系统架构如下图所示：

从上图可以看出，当客户端访问文件时，

#### 3.3 索引的设计

对对象的操作无外乎增、删、改、查，其中，最常用的就是增和查，分别对应于对象的写和读。然而，将若干个小对象合并成一个大对象后，关键的问题是：给定小对象的ID，如何读取该小对象。因此，为了查找某个特定的小对象，对每个合并对象建立一个索引文件，索引文件中的每个索引分别对应于合并对象中的每个对象。

索引的设计包括：索引文件的结构和索引的访问。

最简单的索引文件的结构是，合并对象中的小对象和索引文件中的索引按照顺序一一对应，如下图所示，这种方式实现比较简单，但是，当客户端写入一个对象时，存储服务器需要进行两次写入操作：一次是写合并对象，一次是写索引文件。导致开销较大。

另一种方式是，对索引文件建立缓存，如下图所示，该方法将索引文件在内存中构成一个哈希表，当要写入索引时，将索引信息写入哈希表，然后在适当的时机将索引信息同步到持久存储。该方法的问题是，从索引文件构建内存哈希表有开销，导致存储服务器启动较慢，而且，当存储服务器意外宕机时，内存中的索引信息有可能与持久存储的索引信息不同步，从而导致索引信息的丢失。

这里采用的方法既可以满足上面的提到的开销问题，又可以保证索引信息的同步。

如下图所示，将索引文件构造成隐式哈希表，对它的访问采用共享内存。

#### 3.4 合并对象的元数据管理

确切地说，将小对象合并后，元数据的数量其实是增多了，因为合并对象本身也有元数据，问题在于，如何高效地管理合并对象的元数据，减小管理元数据的开销。
