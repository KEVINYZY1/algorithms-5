### epoll

#### 1 epoll的电平触发和边沿触发

epoll有两种事件通知方式：电平出发(LT)和边沿触发(ET)。下面我们来看看两种方式的不同点。

假设发生以下情形：
1. 管道的读端的描述符rfd已经注册到epoll实例;
2. 向管道的写端写入2KB数据;
3. epoll_wait返回，并返回可以进行读操作的文件描述符rfd;
4. 从管道中读取1KB的数据;
5. epoll_wait调用完成。

如果在添加rfd文件描述符时指定EPOLLET标志，尽管文件读取缓冲区中仍然有可读数据，上面第5步epoll_wait调用会被挂起；同时，对端可能期望收到它已经发送的数据的响应。因为边沿触发只是在监听的文件描述符上发生事件时才会传递事件。因此，第5步中调用者不会等待读取缓冲区中的部分数据。在这个例子中，由于第2步的写操作，在rfd上产生事件，然后该事件被第3步消耗。又由于第4步的读操作没有读取所有的数据，第5步对epoll_wait可能会无限阻塞。

采用EPOLLET标志的应用程序应该使用非阻塞的文件描述符，以避免阻塞的读或者写操作饿死处理多个文件描述符的任务。建议以下面的方式使用epoll的边沿触发：
* 使用非阻塞的文件描述符;
* 只有当read()或者write()操作返回EAGAIN时才等待事件发生。read()返回EAGAIN说明文件描述符是非阻塞的，但是，此时没有数据可读，write()类似。因此，如果返回EAGAIN，说明已经完成了任务。

相比而言，以电平方式(默认是电平出发)使用的话，epoll就是一个快速的poll。

但是，即使使用边沿触发的epoll，如果接收到多个数据块就会发生多个事件，调用者可以指定EPOLLONESHOT标志告诉epoll，在epoll_wait收到一个事件之后，就使相关的文件描述符不可用。当指定EPOLLONESHOT标志时，调用者有责任使用epoll_ctl来重新使文件描述符可用。

所以有：
电平触发(LT)：发生事件了，通知你，直到你完成任务为止。这是默认方式。
边沿触发(ET)：发生事件了，只通知一次，不处理拉倒。
